# Bivariate dependencies and relationships

```{r 04-libraries, include = FALSE, message=FALSE}
library(tidyverse)
library(patchwork)
library(VGAMdata)
library(nycflights13)
library(ggplot2movies)
library(datasauRus)
library(gt)
library(mvtnorm)
library(ggExtra)
library(ggthemes)
library(nullabor)
```

## Motivation

<!-- The story of the galloping horse

- My own painting: hills 
- Reflection of lemons
- Green trees

Tendency to repeat what other people have reported, or impose prior beliefs. 

Look again, see with fresh eyes

## The humble scatterplot
-->

> Scatter plots are glorious. Of all the major chart types, they are by far the most powerful. They allow us to .monash-orange2[quickly understand relationships] that would be nearly impossible to recognize in a table or a different type of chart. ... Michael Friendly and Daniel Denis, psychologists and historians of graphics, call the scatter plot the most "generally useful invention in the history of statistical graphics." [Dan Kopf](https://qz.com/1235712/the-origins-of-the-scatter-plot-data-visualizations-greatest-invention/)

::: info
Scatterplots are the natural plot to make to explore association between two **continuous** (quantitative or numeric) variables].
:::

They are not just for linear relationships but are useful for examining nonlinear patterns, clustering and outliers. 

We also can think about scatterplots in terms of statistical distributions: if a histogram shows a marginal distribution, a scatterplot allows us to examine the bivariate distribution of a sample.

### History

Descartes provided the Cartesian coordinate system in the 17$^{th}$ century, with perpendicular lines indicating two axes. 

It wasn't until 1832 that the scatterplot appeared, when [John Frederick Herschel](http://www.datavis.ca/milestones/index.php?group=1800%2B) [@friendly_denis] plotted position and time of double stars.
This is 50 years after [bar charts and line charts](http://www.datavis.ca/milestones/index.php?group=1700s) appeared, used in the work of William Playfair to examine economic data. Kopf argues that *The scatter plot, by contrast, proved more useful for scientists*, but it clearly is useful for economics today.


### Language and terminology

The words "correlation" and "association" are NOT interchangeable. In the English language correlation means a mutual relationship or connection between two things. However, the statistic called correlation ONLY describes linear relationships. 

::: info
If the relationship is NOT linear, call use the term association to describe it. Use the term correlated only for linear relationships to avoid confusion related to the statistic.]
:::


## Common features and their names

```{r scatterplots, echo=FALSE, include = FALSE, fig.width = 2, fig.height = 2}
set.seed(55555)
d_trend <- tibble(x = runif(100) - 0.5) %>%
  mutate(positive=4*x+rnorm(100)*0.5, 
         none=rnorm(100)*0.5, 
         negative=-4*x+rnorm(100)*0.5) %>%
  pivot_longer(cols=positive:negative, names_to="trend", values_to="y") %>%
  mutate(trend = factor(trend, 
                        levels=c("positive", "none", "negative"))) %>%
  select(trend, x, y)

d_trend %>% 
  filter(trend == "positive") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_trend %>% 
  filter(trend == "negative") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_trend %>% 
  filter(trend == "none") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_strength <- tibble(x = runif(100) -0.5) %>%
  mutate(strong=4*x+rnorm(100)*0.5, 
         moderate=4*x+rnorm(100), 
         weak=-4*x+rnorm(100)*3) %>%
  pivot_longer(cols=strong:weak, 
               names_to="strength", values_to="y") %>%
  mutate(strength = factor(strength, 
                           levels=c("strong", "moderate", "weak"))) %>%
  select(strength, x, y)

d_strength %>% 
  filter(strength == "strong") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_strength %>% 
  filter(strength == "moderate") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_strength %>% 
  filter(strength == "weak") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

```

```{r scatterplots2, echo=FALSE, include = FALSE, fig.width = 2, fig.height = 2}
d_form <- tibble(x = runif(100) -0.5) %>%
  mutate(linear=4*x+rnorm(100)*0.5, 
         nonlinear1=12*x^2+rnorm(100)*0.5,
         nonlinear2=2*x - 5*x^2 +rnorm(100)*0.1) %>%
  pivot_longer(cols=linear:nonlinear2, names_to="form", 
               values_to="y") %>%
  select(form, x, y)

d_form %>% 
  filter(form == "linear") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_form %>% 
  filter(form == "nonlinear1") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_form %>% 
  filter(form == "nonlinear2") %>%
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_outliers <- tibble(x = runif(100) -0.5) %>%
  mutate(y=4*x+rnorm(100)*0.5)
d_outliers <- d_outliers %>%
  bind_rows(tibble(x=runif(5)/10-0.45, y=2+rnorm(5)*0.5))

d_outliers %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_clusters <- tibble(x = c(rnorm(50)/6 - 0.5, 
                           rnorm(50)/6, 
                           rnorm(50)/6 + 0.5)) %>%
  mutate(y=c(rnorm(50)/6,
         rnorm(50)/6+1, rnorm(50)/6))

d_clusters %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

d_gaps <- tibble(x = runif(150)) %>%
  mutate(y=runif(150))
d_gaps <- d_gaps %>%
  filter(!(between(x+2*y, 1.2, 1.6)))

d_gaps %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_polygon(data=tibble(x=c(0, 1, 1, 0), y=c(1.2/2, 0.2/2, 0.6/2, 1.6/2)), 
               fill = "red", alpha = 0.3) +
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

```

```{r scatterplots3, echo=FALSE, include = FALSE, fig.width = 2, fig.height = 2}
d_barrier <- tibble(x = runif(200)) %>%
  mutate(y=runif(200))
d_barrier <- d_barrier %>%
  filter(-x+3*y<1.2)

d_barrier %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_polygon(data=tibble(x=c(0, 1, 1, 0), y=c(1.2/3, 2.2/3, 1, 1)), 
               fill = "red", alpha = 0.3) +
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

l_shape <- tibble(x = c(rexp(50, 0.01), runif(50)*20), 
                  y = c(runif(50)*20, rexp(50, 0.01)))

l_shape %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

discrete <- tibble(x = rnorm(200)) %>%
  mutate(y = -x+rnorm(25)*0.1 + rep(0:7, 25)) %>%
  filter((scale(x)^2 + scale(y)^2) < 2)

discrete %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

hetero <- tibble(x = runif(200)-0.5) %>%
  mutate(y = -2*x+rnorm(200)*(x+0.5))

hetero %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() + 
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))
  
weighted <- tibble(x = runif(50)-0.5) %>%
  mutate(y = -2*x+rnorm(50)*0.8, 
         w = runif(50)*(x+0.5))

weighted %>% 
  ggplot(aes(x=x, y=y, size=w+0.1)) + 
  geom_point(alpha=0.7) + 
  scale_size_area(max_size=6) +
  theme_void() + 
  theme(aspect.ratio = 1, legend.position = "none",
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

```




```{r feature-table, echo=FALSE}
tribble(~Feature, ~Example, ~Description,
        "positive trend", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-1.png" height ="54px">',  "Low value corresponds to low value, and high to high.",
        "negative trend", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-2.png" height ="54px">', "Low value corresponds to high value, and high to low.",
        "no trend", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-3.png" height ="54px">', 'No relationship',
        "strong", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-4.png" height ="54px">',  "Very little variation around the trend",
        "moderate", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-5.png" height ="54px">', "Variation around the trend is almost as much as the trend",
        "weak", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots-6.png" height ="54px">', 'A lot of variation making it hard to see any trend',
        "linear form", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-1.png" height ="54px">',  "The shape is linear",
        "nonlinear form", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-2.png" height ="54px">', "The shape is more of a curve",
        "nonlinear form", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-3.png" height ="54px">', 'The shape is more of a curve',
        "outliers", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-4.png" height ="54px">', 'There are one or more points that do not fit the pattern on the others',
        "clusters", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-5.png" height ="54px">', 'The observations group into multiple clumps',
        "gaps", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots2-6.png" height ="54px">', 'There is a gap, or gaps, but its not clumped',
        "barrier", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots3-1.png" height ="54px">', 'There is combination of the variables which appears impossible',
        "l-shape", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots3-2.png" height ="54px">', 'When one variable changes the other is approximately constant',
        "discreteness", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots3-3.png" height ="54px">', 'Relationship between two variables is different from the overall, and observations are in a striped pattern',
        "heteroskedastic", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots3-4.png" height ="54px">', 'Variation is different in different areas, maybe depends on value of x variable',
        "weighted", '<img src="_bookdown_files/eda-book_files/figure-html/scatterplots3-5.png" height ="54px">', 'If observations have an associated weight,  reflect in scatterplot, e.g. bubble chart'
) %>% 
  knitr::kable(escape = FALSE) %>% 
  kableExtra::kable_classic()
```

- **Weighted** doesn't fit structure table, but its there to remind us not to forget about weighted data
- **causation**: one variable has a direct influence on the other variable, in some way. For example, people who are taller tend to weigh more. The dependent variable is conventionally on the y axis. *It's not generally possible to tell from the plot that the relationship is causal, which typically needs to be argued from other sources of information.*
- **association**: variables may be related to one another, but through a different variable, eg ice cream sales are positively correlated with beach drownings, is most likely a temperature relationship.
- **conditional relationships**: the relationship between variables is conditionally dependent on another, such as income against age likely has a different relationship depending on retired or not.

### Anscombe's quartet

```{r anscombe, echo=FALSE, fig.width=6, fig.height=2, out.width="100%"}
anscombe_tidy <- anscombe %>% 
  pivot_longer(cols=x1:y4, names_to = "var", values_to = "value") %>%
  mutate(group = substr(var, 2, 2), 
         var = substr(var, 1, 1), 
         id = rep(1:11, rep(8, 11))) %>%
  pivot_wider(id_cols = c(id, group), names_from = var, 
              values_from = value) 
anscombe_tidy %>%
  ggplot(aes(x=x, y=y)) + 
    geom_point(colour="orange", size=3) +
    facet_wrap(~group, ncol=4, scales="free") +
    theme(aspect.ratio=1, 
          axis.text.x = element_blank(),
          axis.text.y = element_blank())
```

All four sets of Anscombe has .monash-orange2[same means, standard deviations and correlations], $\bar{x}$ = `r mean(anscombe$x1)`, $\bar{y}$ = `r round(mean(anscombe$y1),1)`, $s_x$ = `r round(sd(anscombe$x1),1)`, 
$s_y$ = `r round(sd(anscombe$y1),1)`, $r$ = `r round(cor(anscombe$x1, anscombe$y1), 2)`.


### DatasauRus dozen

```{r dinosaur, echo=FALSE, out.width="30%", fig.width=3, fig.height=2.8}
datasaurus_dozen %>% filter(dataset == "dino") %>% 
  ggplot(aes(x=x, y=y)) + 
  geom_point() +
  theme(aspect.ratio=1, 
       axis.text.x = element_blank(),
       axis.text.y = element_blank())
  
```

```{r datasaurus, echo=FALSE, fig.height = 7, fig.width = 7, out.width="60%"}

datasaurus_dozen %>% filter(dataset != "dino") %>% ggplot(aes(x=x, y=y)) + 
  geom_point() +
  facet_wrap(~dataset, ncol=4) +
  theme(aspect.ratio=1, 
          axis.text.x = element_blank(),
          axis.text.y = element_blank())
```

All 13 sets of the datasaurus dozen have .monash-orange2[same means, standard deviations and correlations], $\bar{x}$ = `r d <- datasaurus_dozen_wide; round(mean(d$dino_x),0)`, $\bar{y}$ = `r round(mean(d$dino_y),0)`, $s_x$ = `r round(sd(d$dino_x),0)`, 
$s_y$ = `r round(sd(d$dino_y),0)`, $r$ = `r round(cor(d$dino_x, d$dino_y),2)`.


## Case study 1: olympics

```{r olydata, echo=FALSE, warning = FALSE}
data(oly12, package = "VGAMdata")
glimpse(oly12)
oly12 <- oly12 %>% 
  mutate(Sport = as.character(Sport)) %>%
  mutate(Sport = ifelse(grepl("Cycling", Sport), #<<
                        "Cycling", Sport)) %>%  #<<
  mutate(Sport = ifelse(grepl("Gymnastics", Sport),
                        "Gymnastics", Sport)) %>% 
  mutate(Sport = ifelse(grepl("Athletics", Sport),
                        "Athletics", Sport)) %>% 
  mutate(Sport = as.factor(Sport))

```

```{r 2012-olympics-plot1, echo=FALSE, warning = FALSE, fig.width = 6.4}
ggplot(oly12, aes(x=Height, y=Weight, label=Sport)) + 
  geom_point() 
```

* `Warning message: Removed 1346 rows containing missing values (geom_point)`
* The expected linear relationship between height and weight is visible, although obscured by outliers.
* Some discretization of heights, and higher weight values. 
* Likely to be substantial overplotting (57 athletes 1.7m, 60kg can't tell this from this plot). 
* Note the unusual height-weight combinations. What sport(s) would you expect some of these athletes might be participating in?

::: do
Your turn, cut and paste the code into your R console, and `r anicon::nia("mouse over", size=2, animate="ring", speed="slow", colour="#D93F00", anitype="hover")` the resulting plot to examine the sport of the athlete. 

```{r echo=FALSE, warning = FALSE, fig.width = 12, fig.height=8, out.width="100%", eval=FALSE, echo=TRUE}
library(tidyverse) 
library(plotly) 
data(oly12, package = "VGAMdata") 
p <- ggplot(oly12, aes(x=Height, y=Weight, label=Sport)) + 
  geom_point()
ggplotly(p) 
```
:::

### How many athletes in the different sports? 

```{r oly_smry, echo=FALSE, warning = FALSE}
oly12 %>% 
  count(Sport, sort=TRUE) %>%
  gt() 
```

### Consolidate factor levels

There are several cycling events that are reasonable to combine into one category. Similarly for gymnastics and athletics. 


```{r oly_cat, echo=TRUE, warning = FALSE}
oly12 <- oly12 %>% 
  mutate(Sport = as.character(Sport)) %>%
  mutate(Sport = ifelse(grepl("Cycling", Sport), #<<
                        "Cycling", Sport)) %>%  #<<
  mutate(Sport = ifelse(grepl("Gymnastics", Sport),
                        "Gymnastics", Sport)) %>% 
  mutate(Sport = ifelse(grepl("Athletics", Sport),
                        "Athletics", Sport)) %>% 
  mutate(Sport = as.factor(Sport))
```

### Split by sport

```{r oly_facet, echo=FALSE, warning = FALSE, out.width="70%", fig.width=12, fig.height=7}
ggplot(oly12, aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.5) + #<<
  facet_wrap(~Sport, ncol=8) +
  theme(aspect.ratio = 1) #<<
```

Note: alpha transparency, and aspect ratio


- Some sports have no data for height, weight
- The positive association between height and weight is visible across sports
- Nonlinear in wrestling?
- An outlier in judo, and football, and archery
- Maybe flatter among swimmers
- Taller in basketball, volleyball and handball
- Shorter in athletics, weightlifting and wrestling
- Little variance in tennis players
- *It's still messy, and hard to digest*

Things to do to make comparisons easier:

- Remove sports with missings
- Make regression lines for remaining sports on one plot
- Separately examine male/female athletes
- Compare just one group against the rest

### Remove missings, add colour for sex 

```{r oly_women, echo=FALSE, warning = FALSE, out.width="70%", fig.width=12, fig.height=7}
oly12 %>%
  filter(!(Sport %in% c("Boxing", "Gymnastics", "Synchronised Swimming", "Taekwondo", "Trampoline"))) %>%
  mutate(Sport = fct_drop(Sport)) %>%
  ggplot(aes(x=Height, y=Weight, colour=Sex)) + 
  geom_point(alpha=0.5) + 
  facet_wrap(~Sport, ncol=7, scales="free") +
  scale_colour_brewer("", palette="Dark2") +
  theme(aspect.ratio = 1, 
        axis.text.x = element_blank(),
        axis.text.y = element_blank()) 
```

Note: Because the focus is now on males vs females association shape within sport, make plots scale separately.

- Athletics category should have been broken into several more categories like track, field: a shot-putter has a very different physique to a sprinter.
- Generally, clustering of male/female athletes
- Outliers: a tall skinny male archer, a medium height very light female athletics athlete, tall light female weightlifter, tall light male volleyballer
- Canoe slalom athletes, divers, cyclists are tiny.

### Comparing association

```{r oly_model, echo=FALSE, warning = FALSE, out.width="100%", fig.width=10, fig.height=8}
oly12 %>%
  filter(Sport %in% c("Swimming", "Archery", "Basketball",
                      "Handball", "Hockey", "Tennis",
                      "Weightlifting", "Wrestling")) %>%
  filter(Sex == "F") %>%
  mutate(Sport = fct_drop(Sport), Sex=fct_drop(Sex)) %>%
  ggplot(aes(x=Height, y=Weight, colour=Sport)) + 
  geom_smooth(method="lm", se=FALSE) + #<<
  scale_colour_brewer("", palette="Dark2") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")
```

- Weightlifters are much heavier relative to height
- Swimmers are leaner relative to height
- Tennis players are a bit mixed, shorter tend to be heavier, taller tend to be lighter

### Comparing variability

```{r oly_density, echo=FALSE, warning = FALSE, out.width="100%", fig.width=10, fig.height=8}
oly12 %>%
  filter(Sport %in% c("Shooting", "Modern Pentathlon", "Basketball")) %>% #<<
  filter(Sex == "F") %>%
  mutate(Sport = fct_drop(Sport), Sex=fct_drop(Sex)) %>%
  ggplot(aes(x=Height, y=Weight, colour=Sport)) + 
  geom_density2d() + #<<
  scale_colour_brewer("", palette="Dark2") +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")
```

- Modern pentathlon athletes are uniformly height and weight related
- Shooters are quite varied in body type

### Summary

We have seen that the association between height and weight is "contaminated" by different variables, sport, gender, and possibly country and age, too. 

Some of the categories also are "contaminated", for example, "Athletics" is masking many different types of events. This **lurking** variable probably contributes to different relationships depending on the event. There is another variable in the data set called `Event`. Athletics could be further divided based on key words in this variable. 

::: question
If you were just given the Height and Weight in this data could you have detected the presence of conditional relationships? Can you see the conditional dependencies?
:::

```{r oly_canyousee, echo=FALSE, warning = FALSE, fig.width=8, fig.height=8, out.width="70%"}
p1 <- ggplot(oly12, aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.2, size=4) +
  theme_minimal() + theme(aspect.ratio=1)
p2 <- ggplot(oly12, aes(x=Height, y=Weight)) + 
  geom_density2d_filled() +
  theme_minimal() + 
  theme(legend.position="none", aspect.ratio=1) 
p3 <- ggplot(oly12, aes(x=Height, y=Weight)) + 
  geom_density2d(binwidth=0.01) +
  theme_minimal() + theme(aspect.ratio=1)
p4 <- ggplot(oly12, aes(x=Height, y=Weight)) + 
  geom_density2d(binwidth=0.001, color = "white", size=0.2) +
  geom_density2d_filled(binwidth=0.001) +
  theme_minimal() + 
  theme(legend.position="none", aspect.ratio=1) 
p1 + p3 + p2 + p4
```

There is a hint of multimodality, barely a hint. It's not easy to detect the presence of the additional variable, and thus accurately describe the relationship between height and weight among Olympic athletes.

### Scatterplot modifications and purpose

```{r generate_data, echo=FALSE}
set.seed(2222)
df <- tibble(x=c(rnorm(500)*0.2, runif(300)+1)) %>%
  mutate(x2=c(rnorm(500), runif(300)-0.5),
         y1=c(-2*x[1:500]+rnorm(500), 
              3*x[501:800] + rexp(300)), 
         y2=c(rep("A", 500), rep("B", 300)),
         y3=c(-2*(x2[1:500]) + rnorm(500)*2, 
              2*(x2[501:800]) + rnorm(300)*0.5))
```

```{r scatmodify, include=FALSE, fig.width=2, fig.height=2, out.width="100%"}
ggplot(df, aes(x=x2, y=y3)) +
  geom_point() + xlab("") + ylab("") +
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x2, y=y3)) + 
  geom_point(alpha=0.1) + xlab("") + ylab("") +
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x2, y=y3)) +
  geom_smooth(colour="purple", se=F, size=2, span=0.2) + xlab("") + ylab("") +
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x2, y=y3)) +
  geom_point(alpha=0.2) +
  geom_smooth(colour="purple", se=F, size=2, span=0.2) + 
  xlab("") + ylab("") +
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x, y=y1)) +
  geom_density_2d(colour="black") + xlab("") + ylab("") +
  theme_void() + 
  theme(aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x, y=y1)) +
  geom_density_2d_filled() + xlab("") + ylab("") +
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x, y=y1, colour=y2)) +
  geom_point(alpha=0.2) + xlab("") + ylab("") +
  scale_colour_brewer("", palette="Dark2") +
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))

ggplot(df, aes(x=x, y=y1, colour=y2)) +
  geom_density2d() + xlab("") + ylab("") +
  scale_colour_brewer("", palette="Dark2") + 
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))
```

```{r feature-table4, echo=FALSE}
tribble(~Modification, ~Example, ~Purpose,
        "none", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-1.png" height ="54px">', 'raw information',
        "alpha-blend", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-2.png" height ="54px">', 'alleviate overplotting to examine density at centre',
        "model overlay", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-3.png" height ="54px">', 'focus on the trend',
        "model + data", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-4.png" height ="54px">', 'trend plus variation',
        "density", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-5.png" height ="54px">', 'overall distribution, variation and clustering',
        "filled density", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-6.png" height ="54px">', 'high density locations in distribution (modes), variation and clustering',
        "colour", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-7.png" height ="54px">', 'relationship with conditioning and lurking variables',
        "colour + density", '<img src="_bookdown_files/eda-book_files/figure-html/scatmodify-8.png" height ="54px">', 'relationship with conditioning and lurking variables'
) %>% 
  knitr::kable(escape = FALSE) %>% 
  kableExtra::kable_classic()
```

::: do
**About the Olympics 2012 data**

- What can this data be used for?
- What's the population?
- What could be informed by what is learned from this sample?
:::

## Numerical measures of association

### Correlation

Correlation between variables $x_1$ and $x_2$, with $n$ observations in each.

$$r = \frac{\sum_{i=1}^n (x_{i1}-\bar{x}_1)(x_{i2}-\bar{x}_2)}{\sqrt{\sum_{i=1}^n(x_{i1}-\bar{x}_1)^2\sum_{i=1}^n(x_{i2}-\bar{x}_2)^2}} = \frac{\mbox{covariance}(x_1, x_2)}{(n-1)s_{x_1}s_{x_2}}$$
- Test for statistical significance, whether population correlation could be 0 based on observed $r$, using a $t_{n-2}$ distribution:

$$t=\frac{r}{\sqrt{1-r^2}}\sqrt{n-2}$$
TO DO: Tabulate the examples below

```{r}
set.seed(45)
d1 <- tibble(x=runif(200)-0.5) %>%
  mutate(y = 2*x + rnorm(200))
d1_p <- ggplot(d1, aes(x=x, y=y)) + 
  geom_point() +
  theme(aspect.ratio=1)
d1_p
```

```{r echo=TRUE}
cor(d1$x, d1$y) 
```

```{r echo=TRUE, highlight.output = c(5)}
cor.test(d1$x, d1$y) 
```


```{r}
d2 <- tibble(x=runif(200)-0.5) %>%
  mutate(y = x^2 + rnorm(200)*0.01)
d2_p <- ggplot(d2, aes(x=x, y=y)) + 
  geom_point() +
  theme(aspect.ratio=1)
d2_p
```

```{r echo=TRUE}
cor(d2$x, d2$y) 
```

```{r echo=TRUE, highlight.output = c(5)}
cor.test(d2$x, d2$y) 
```

```{r}
d3 <- tibble(x = c(rnorm(200), 10)) %>%
  mutate(y = c(rnorm(200), 10))
d3_p <- ggplot(d3, aes(x=x, y=y)) + 
  geom_point() +
  theme(aspect.ratio=1)
d3_p 
```

All observations

```{r echo=FALSE, highlight.output = c(2,3,9,10)}
cor.test(d3$x, d3$y)[c(4,1,3)] 
```

Without outlier

```{r echo=FALSE, highlight.output = c(2,3,9,10)}
cor.test(d3$x[1:200], d3$y[1:200])[c(4,1,3)] 
```

### Peceiving correlation

```{r simcor, fig.width=10, fig.height=5, out.width="70%"}
set.seed(7777)
vc <- matrix(c(1,0,0,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p1 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,0.4,0.4,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p2 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,0.6,0.6,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p3 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,0.8,0.8,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p4 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,-0.2,-0.2,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p5 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,-0.5,-0.5,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p6 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,-0.7,-0.7,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p7 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
vc <- matrix(c(1,-0.9,-0.9,1), ncol=2, byrow=T)
d <- as_tibble(rmvnorm(500, sigma=vc))
p8 <- ggplot(d, aes(x=V1, y=V2)) +
  geom_point() + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
p1 + p2 + p3 + p4 + p5 + p6 + p7 + p8 + plot_layout(ncol=4)
```


```{r fig.width = 4, fig.height = 2, out.width="40%"}
a1 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = 0.0")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a2 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = 0.4")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a3 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = 0.6")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a4 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = 0.8")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a5 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = -0.2")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a6 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = -0.5")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a7 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = -0.7")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a8 <- ggplot() +
  geom_text(aes(x=0, y=0, label="r = -0.9")) + 
  theme_void() +
  theme(aspect.ratio=1, 
        plot.background=element_rect(fill="gray90"))
a1 + a2 + a3 + a4 + a5 + a6 + a7 + a8 + plot_layout(ncol=4)
```

Generally, people don't do very well at this task. Typically people under-estimate $r$ from scatterplots, particularly when it is around 0.4-0.7. The variation in a scatterplot perceptually doesn't vary is not linearly with $r$.

::: info
When someone says *correlation is 0.5* it sounds impressive. BUT when someone shows you a scatterplot of data that has correlation 0.5, you will say that's a weak relationship.
:::

### Robust correlation measures 

- Spearman (based on ranks)
    - Sort each variable, and return rank (of actual value)
    - Compute correlation between ranks of each variable

```{r}
set.seed(60)
df <- tibble(x=c(round(rnorm(5), 1), 10), 
             y=c(round(rnorm(5), 1), 10)) %>%
  mutate(xr = rank(x), yr = rank(y))
df
```

```{r echo=TRUE}
cor(df$x, df$y)
cor(df$xr, df$yr)
cor(df$x, df$y, method = "spearman")
```

### Robust correlation measures 

- Kendall $\tau$ (based on comparing pairs of observations)
    - Sort each variable, and return rank (of actual value)
    - For all pairs of observations $(x_i, y_i), (x_j, y_j)$, determine  if **concordant**, $x_i < x_j, y_i < y_j$ or $x_i > x_j, y_i > y_j$, or **discordant**, $x_i < x_j, y_i > y_j$ or $x_i > x_j, y_i < y_j$.

$$\tau = \frac{n_c-n_d}{\frac12 n(n-1)}$$

```{r out.width="70%"}
ggplot(df, aes(x=x, y=y)) + 
  annotate("rect", xmin = -2, xmax = df$x[2], 
           ymin = -2, ymax = df$y[2],
           fill="red", alpha=0.5, colour=NA) +
  annotate("rect", xmin = df$x[2], xmax = 11, 
           ymin = df$y[2], ymax = 11,
           fill="red", alpha=0.5, colour=NA) +
  annotate("text", x = 3, y = 10, label = "concordant", colour="red") +
  annotate("text", x = 5, y = -1.5, label = "disconcordant") +
  geom_point() +
  annotate("point", x = df$x[2], y = df$y[2], color="red") +
  theme(aspect.ratio=1)
```

```{r echo=TRUE}
cor(df$x, df$y)
cor(df$x, df$y, method = "kendall")
```

### Comparison of correlation measures

```{r diffscatter, fig.height=2, fig.width=2, include=FALSE}
d1_p + 
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))
d2_p + 
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))
d3_p + 
  theme_void() + 
  theme(legend.position="none", aspect.ratio = 1, 
        axis.line.x = element_line(color = "black", size = 2),
        axis.line.y = element_line(color = "black", size = 2))
```

```{r corr-table}
tribble(~sample, ~corr, ~spearman, ~kendall,
        '<img src="images/lecture-05B/diffscatter-1.png" height ="100px">', 
        cor(d1$x, d1$y), 
        cor(d1$x, d1$y, method="spearman"), 
        cor(d1$x, d1$y, method="kendall"),
        '<img src="images/lecture-05B/diffscatter-2.png" height ="100px">', 
        cor(d2$x, d2$y), 
        cor(d2$x, d2$y, method="spearman"), 
        cor(d2$x, d2$y, method="kendall"),
        '<img src="images/lecture-05B/diffscatter-3.png" height ="100px">', 
        cor(d3$x, d3$y), 
        cor(d3$x, d3$y, method="spearman"), 
        cor(d3$x, d3$y, method="kendall")
) %>% 
  knitr::kable(escape = FALSE, digits=3) %>% 
  kableExtra::kable_styling(full_width = FALSE) %>%
  kableExtra::kable_classic()
```

## Case study 2: movies

```{r movies, fig.width=6, fig.height=6, out.width="80%"}
ggplot(movies, aes(x=votes, y=rating)) +
  geom_point() + 
  scale_y_continuous("rating", breaks = seq(0, 10, 2))
```

- `votes`: Number of IMDB users who rated this movie
- `rating`: Average IMDB user rating

Describe the relationship between rating and votes. 

- Odd pattern, almost looks like an "r"
- No films with lots of votes and low rating
- No film with lots of votes has rating close to maximum possible: **barrier?**
- Films with very high ratings only have a few votes
- Generally, rating appears to increase as votes increases (its hard to really read this with so few points though)
- A few films with really large number of votes: **outliers?** or just **skewness?**
- Films with few votes have ratings that span the range of the scale.

**Examine votes on a log scale**

```{r logmovies, fig.width=6, fig.height=6, out.width="80%"}
ggplot(movies, aes(x=votes, y=rating)) +
  geom_point(alpha=0.1) + 
  geom_smooth(se=F, colour="orange", size=2) +
  scale_x_log10() + 
  scale_y_continuous("rating", breaks = seq(0, 10, 2))
```

- Some positive association between two variables only for large number of votes.
- *Note*: Used transparency (because there is a lot of data) and a loess smooth (because I am interested in assessing the trend between votes and rating).

Correlation between raw variables is `r round(cor(movies$votes, movies$rating), 2)` and between transformed `log(votes)` and `rating` is `r round(cor(log10(movies$votes), movies$rating), 2)`. Which more accurately reflects the relationship?

## Case study 3: cars

```{r cars, fig.width=6, fig.height=6, out.width="80%"}
data(mtcars)
ggplot(mtcars, aes(x=hp, y=mpg)) +
  geom_point() + 
  geom_smooth(colour="forestgreen", se=F) 
```

- `mpg`: Miles/(US) gallon
- `hp`: Gross horsepower


- negative: as horsepower increases fuel efficiency is worse
- nonlinear: for lower horse power the decrease in efficieny is more
- strong: very little variation between cars, looks fundamentally like a physics problem
- outlier: one car with high horse power has unusually high efficiency

**Transform horsepower on log scale**

```{r logcars, fig.width=6, fig.height=6, out.width="80%"}
ggplot(mtcars, aes(x=hp, y=mpg)) +
  geom_point() + 
  scale_y_log10("log mpg") + #<<
  geom_smooth(method="lm", colour="forestgreen", se=F) +
  geom_smooth(data=filter(mtcars, hp<300), method="lm", colour="orangered", se=F, lty=2)
```

Log transforming `mpg` linearised the relationship between horsepower and mpg. 

Correlation between raw variables is `r round(cor(mtcars$hp, mtcars$mpg), 2)` <br> and between transformed `log(mpg)` and `hp` is `r round(cor(log10(mtcars$hp), mtcars$mpg), 2)`. Which more accurately reflects the relationship?

How does the correlation change if outlier is removed?

## Circle of transformations for linearising

```{r circleoftrans, fig.width=5, fig.height=5, out.width="80%"}
x <- c(seq(-0.95, -0.1, 0.025), seq(0.1, 0.95, 0.025))
x <- c(x, x)
d <- tibble(x, y = sqrt(1-x^2), 
            q=c(rep("4", 35), 
                rep("1", 35),
                rep("3", 35),
                rep("2", 35)))
d$y[71:140] <- -d$y[71:140]
ggplot(d, aes(x=x, y=y, colour=q, group=q)) +
  geom_line(size=2) +
  annotate("text", x=c(0.5, 0.5, -0.5, -0.5),
           y=c(0.5, -0.5, -0.5, 0.5), 
           label=c("x up, y up", "x up, y down", 
                   "x down, y down", "x down, y up"),
           size=5) +
  geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  annotate("text", x=0, y=0, label="(0,0)", size=10) +
  theme_void() +
  theme(aspect.ratio=1, legend.position = "none")
```


Remember the power ladder: 

-1, 0, 1/3, 1/2, .monash-orange2[1], 2, 3, 4 

1. Look at the shape of the relationship. 
2. Imagine this to be a number plane, and depending on which quadrant the shape falls in, you either transform $x$ or $y$, up or down the ladder: `+,+` both up; `+,-` x up, y down; `-,-` both down;  `-,+` x down, y up
    
If there is heteroskedasticity, try transforming $y$, may or may not help.

## Case study 4: soils

```{r baker, fig.width=5, fig.height=5, out.width="80%"}
baker <- read_csv("data/baker.csv")
p <- ggplot(baker, aes(x=B, y=Corn97BU)) +
  geom_point() +
  xlab("Boron (ppm)") +
  ylab("Corn Yield (bushells)") 
ggMarginal(p, type="density")
```

Interplay between skewness and association

Data is from a soil chemical analysis of a farm field in Iowa. Is there a relationship between Yield and Boron?

You can get a marginal plot of each variable added to the scatterplot using `ggMarginal`. This is useful for assessing the skewness in each variable. 

Boron is right-skewed Yield is left-skewed. With skewed distributions in marginal variables it is .monash-orange2[hard] to assess the relationship between the two. Make a transformation to fix, first.

```{r transfbaker, fig.width=5, fig.height=5, out.width="80%"}
p <- ggplot(baker, 
            aes(x=B, y=Corn97BU^2)) + #<<
  geom_point() +
  xlab("log Boron (ppm)") +
  ylab("Corn Yield^2 (bushells)") +
  scale_x_log10() #<<
ggMarginal(p, type="density") #<<
```


```{r bakeriron, fig.width=5, fig.height=5, out.width="80%"}
p <- ggplot(baker, 
            aes(x=Fe, y=Corn97BU^2)) + 
  geom_density2d(colour="orange") +
  geom_point() +
  xlab("Iron (ppm)") +#<<
  ylab("Corn Yield^2 (bushells)") 
ggMarginal(p, type="density") 
```

Lurking variable?

```{r bakerironca, fig.width=5, fig.height=5, out.width="100%"}
ggplot(baker, aes(x=Fe, y=Corn97BU^2,
       colour=ifelse(Ca>5200, #<<
                     "high", "low"))) + #<<
  geom_point() +
  xlab("Iron (ppm)") +
  ylab("Corn Yield^2 (bushells)") +
  scale_colour_brewer("", palette="Dark2") +
  theme(aspect.ratio=1, 
        legend.position = "bottom",
        legend.direction = "horizontal")
```

Colour high calcium (>5200ppm) calcium values

If calcium levels in the soil are high, yield is consistently high. If calcium levels are low, then there is a positive relationship between yield and iron, with higher iron leading to higher yields.




## Case study 5: COVID 

```{r prepdata, eval=FALSE}
# Read data
nyt_county <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")

# Add centroid lat/long
geoCounty_new <- geoCounty %>% as_tibble() %>%
  mutate(fips = as.character(fips),
         county = as.character(county),
         state = as.character(state)) %>%
  select(fips, lon, lat)
nyt_county_total <- nyt_county %>% 
  group_by(fips) %>%
  filter(date == max(date)) %>%
  left_join(geoCounty_new, by=c("fips"="fips"))

save(nyt_county_total, file="../data/nyt_covid.rda")
```

```{r usacovid, fig.width = 10, fig.height = 6.7, out.width="60%"}
load("data/nyt_covid.rda")
usa <- map_data("state")
ggplot() +
  geom_polygon(data=usa, 
               aes(x=long, y=lat, group=group), 
               fill="grey90", colour="white") +
  geom_point(data=nyt_county_total, 
             aes(x=lon, y=lat, size=cases), 
             colour="red", shape=1) +
  geom_point(data=nyt_county_total, 
             aes(x=lon, y=lat, size=cases), 
             colour="red", fill="red", alpha=0.1, shape=16) +
  scale_size("", range=c(1, 30)) + 
  theme_map() + theme(legend.position="none")
```

Bubble plots, size of point is mapped to another variable.

This bubble plot here shows total count of COVID-19 incidence (as of Aug 30, 2020) for every county in the USA, inspired by the [New York Times coverage](https://www.nytimes.com/news-event/coronavirus).

Where has COVID-19 hit the hardest?
<br>

Where are there more people?
<br>

This plot tells you NOTHING except where the population centres are in the USA. To understand relative incidence/risk, report COVID numbers relative the population. For example,  number of cases per 100,000 people.


## Beyond quantitative variables

The type of variable determines the choice of mapping.

- Continuous and categorical $\longrightarrow$ side-by-side boxplots, side-by-side density plots
- Both categorical $\longrightarrow$ faceted bar charts, stacked bar charts, mosaic plots, double decker plots

# Simpsons paradox

There is an additional variable, which if used for conditioning, changes the association between the variables, you have a paradox `r emo::ji("upside_down_face")`.

```{r generate_more_data}
set.seed(2222)
df <- tibble(x=c(rnorm(500)*0.2, runif(300)+1)) %>%
  mutate(y1=c(-2*x[1:500]+rnorm(500), 
              3*x[501:800] + rexp(300)), 
         y2=c(rep("A", 500), rep("B", 300)))
```

```{r scat, fig.width=3, fig.height=3, out.width="70%"}
ggplot(df, aes(x=x, y=y1)) +
  geom_point(alpha=0.5) + xlab("") + ylab("") +
  annotate("text", x=0, y=8, label=paste0("r = ", round(cor(df$x,df$y1), 2))) +
  theme_minimal() 
```

```{r scatcol, fig.width=3, fig.height=3, out.width="70%"}
ggplot(df, aes(x=x, y=y1, colour=y2)) +
  geom_point(alpha=0.5) + xlab("") + ylab("") +
  scale_colour_brewer("", palette="Dark2") +
  annotate("text", x=0, y=8, label=paste0("r = ", round(cor(df$x[df$y2=="A"],df$y1[df$y2=="A"]), 2)), colour="forestgreen") +
    annotate("text", x=1.5, y=0, label=paste0("r = ", round(cor(df$x[df$y2=="B"],df$y1[df$y2=="B"]), 2)), colour="orangered") +
  theme_minimal() + theme(legend.position="none")
```

```{r berkeley, fig.width=10, fig.height=4, out.width="90%"}
ucba <- as_tibble(UCBAdmissions)
a <- ggplot(ucba, aes(Dept)) +
  geom_bar(aes(weight=n))
b <- ggplot(ucba, aes(Admit)) +
  geom_bar(aes(weight=n)) +
  facet_wrap(~Gender)
a + b
```

Did Berkeley .monash-orange2[discriminate] against female applicants?

```{r berkeleydd, fig.width=10, fig.height=4, out.width="100%"}
library(vcd)
ucba <- ucba %>%
  mutate(Admit = factor(Admit, 
            levels=c("Rejected", "Admitted")),
         Gender = factor(Gender, 
            levels=c("Male", "Female"),
            labels=c("M","F")))
doubledecker(xtabs(n~Dept+Gender+Admit, data=ucba),
             gp = gpar(fill=c("grey90", "orangered")))
```

Based on separately examining each department, there is .monash-orange2[no evidence of discrimination] against female applicants.

## Spurious association


## Checking association with permutations

```{r soils-lineup, fig.width=10, fig.height=7, out.width="60%"}
ggplot(lineup(null_permute("Corn97BU"), baker, n=12), 
       aes(x=B, y=Corn97BU)) +
  geom_point() +
  facet_wrap(~.sample, ncol=4)
```

11 of the panels have had the association broken by permuting one variable. There is no association in these data sets, and hence plots. Does the data plot stand out as being different from the null (no association) plots?

```{r oly-lineup, fig.width=10, fig.height=7, out.width="60%"}
data(oly12, package = "VGAMdata") 
oly12_sub <- oly12 %>%
  filter(Sport %in% c("Swimming", "Archery",
                      "Hockey", "Tennis")) %>%
  filter(Sex == "F") %>%
  mutate(Sport = fct_drop(Sport), Sex=fct_drop(Sex)) 

ggplot(lineup(null_permute("Sport"), oly12_sub, n=12),
       aes(x=Height, y=Weight, colour=Sport)) + 
  geom_smooth(method="lm", se=FALSE) + 
  scale_colour_brewer("", palette="Dark2") +
  facet_wrap(~.sample, ncol=4) +
  theme(legend.position="none")
```

11 of the panels have had the association broken by permuting the Sport label. There is no difference in the association between weight and height across sports in these data sets, and hence plots. Does the data plot stand out as being different from the null (no association difference between sports) plots?

# Resources

- Friendly and Denis "Milestones in History of Thematic Cartography, Statistical Graphics and Data Visualisation" available at http://www.datavis.ca/milestones/
- Unwin (2015) [Graphical Data Analysis with R](http://www.gradaanwr.net)
- Graphics using [ggplot2](https://ggplot2.tidyverse.org)
- Wilke (2019) Fundamentals of Data Visualization https://clauswilke.com/dataviz/


## Exercises

1. For each of the following scatterplots, of different Olympic athlete's height and weight identify the visible features, and which is the most surprising.

```{r echo=FALSE, warning = FALSE}
q1a <- oly12 %>% 
  filter(Sport == "Wrestling", 
         Sex == "F") %>%
  ggplot(aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.9, size=3)  +
  ggtitle("Women's wrestling") +
  theme(aspect.ratio=1)
q1b <- oly12 %>% 
  filter(Sport == "Sailing", 
         Sex == "M") %>%
  ggplot(aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.9, size=3)  +
  ggtitle("Men's sailing") +
  theme(aspect.ratio=1)
q1c <- oly12 %>% 
  filter(Sport == "Archery", 
         Sex == "F") %>%
  ggplot(aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.9, size=3)  +
  ggtitle("Female archery") +
  theme(aspect.ratio=1)
q1d <- oly12 %>% 
  filter(Sport == "Rowing", 
         Sex == "F") %>%
  ggplot(aes(x=Height, y=Weight)) + 
  geom_point(alpha=0.9, size=3)  +
  ggtitle("Female rowing") +
  theme(aspect.ratio=1)
q1a + q1b + q1c + q1d
```

<!--
a. positive linear association, discreteness. Most surprising is the discreteness, probably due to weight limits on competition groups.
b. positive linear association, discreteness in both x and y, hint of clumpiness, increasing variance as both x and y increase. Probably the most surprising is the discreteness in both directions. Is there a height limit for some roles on the boat?
c. positive linear association, outlier. The outlier is the most surprising it is a tall and extra heavy archer.
d. positive linear association, clumpiness. Probably some positions in the crew are smaller people, the coxswain. 
-->

2. Guess the correlation between the two variables in each of the previous scatterplots. 

```{r eval=FALSE, echo=FALSE, warning = FALSE}
oly12 %>% 
  filter(Sport == "Wrestling", 
         Sex == "F") %>% 
  select(Height, Weight) %>%
  correlate()
oly12 %>% 
  filter(Sport == "Sailing", 
         Sex == "M") %>%
  select(Height, Weight) %>%
  correlate()
oly12 %>% 
  filter(Sport == "Archery", 
         Sex == "F") %>%
  select(Height, Weight) %>%
  correlate()
oly12 %>% 
  filter(Sport == "Rowing", 
         Sex == "F") %>%
  select(Height, Weight) %>%
  correlate()
```

3. From the following scatterplot, of diamond size and price, what are the most prominent features? 

```{r echo=FALSE, warning = FALSE}
set.seed(344)
diamonds_small <- diamonds %>%
  sample_n(1000)
ggplot(diamonds_small, 
       aes(x=carat, y=price)) +
  geom_point()
```

<!--
positive nonlinear association, heteroskedasticity, outliers, gaps or clumping.
-->

4. In the previous plot of diamonds, what transformation would be recommended based on the "circle of transformations"?

<!-- transform price, down the ladder of powere -->

5. In the following plot of arrival delay and departure delay of flights into and out of the New York City area, what are the most prominent features? 

```{r echo=FALSE, warning = FALSE}
ggplot(flights, 
       aes(x=dep_delay, y=arr_delay)) +
  geom_point()
```

<!--
strong positive association, barrier (arrival delays are not possible to be less than some function of departure delays, might depend on length of flight), heteroskedastic
-->

6. Which of these would be a surprising feature learned from this plot? Why?

- There are negative departure and arrival delays <!-- A bit surprising, but mostly these are small, so some flights leave a fraction early which could happen if all passengers are on board. Early arriving flights are common. -->
- If a flight has a delay in departure it likely will be delayed on arrival <!-- Not surprising, because most likely a flight will be delayed arriving if it started late. -->
- Some flights with negative departure delay have long arrival delays <!-- This is the most surprising, because it means a flight left early but arrived quite late. Physics-wise an early departure should lead to an early arrival. So it makes one think about how the flight could arrive quite late: diverted to avoid a storm, or sat on tarmac after pushing back from gate, or before getting to gate. Requires you to know that departure and arrival times are from and to the gate. -->
- Some flights have long delays <!-- This is reasonably common so it's not surprising.-->
- Some flights with negative arrival delays have positive departure delays <!-- Not so surprising, because a plane can catch up to schedule in-flight. -->

7. A dominant feature in the plot of average rating by number of ratings of  movies in the IMDB database is a barrier, or two barriers, both top and bottom of plot. What is a plausible explanation for this feature?

```{r echo=FALSE, warning = FALSE}
ggplot(movies, aes(x=votes, y=rating)) +
  geom_point() + 
  scale_y_continuous("rating", breaks = seq(0, 10, 2))
```

- As movies become more popular ratings invariably go down <!-- This makes no sense. If it's popular then it will be mostly rated highly. --> 
- There are just very few frequently rated movies and this means it is unlikely to see high values. <!-- A nonsense statement -->
- The lesser rated movies have a lot of variance in their ratings, producing a barrier for the more frequently rated movies. <!-- We could remove the lesser rates movies, and the barrier for frequently rated movies would still exist. -->
- The lesser rated movies have a lot of variance in their ratings, producing a barrier for the more frequently rated movies. <!-- Generally, it is the case that skewness will appear in a plot as less variance in the sparser plot regions. But that is not the pattern causing the barrier in the movies plot. -->
- The average of many values tends to be unlikely to be at the highest and lowest possible values. <!-- This is correct, is a number crunching phenomenon, regression to the mean (?)  -->
